set -eu

# Dependencies - WebTorrent Desktop

base_url="https://1337x.wtf"
cache_dir="$HOME/.cache/notflix"
tmp_html="$cache_dir/tmp.html"
titles="$cache_dir/titles.bw"
seeders_leechers="$cache_dir/seedleech.bw"
sizes="$cache_dir/size.bw"
links="$cache_dir/links.bw"
tmp="$cache_dir/tmp"

mkdir -p "$cache_dir"

menu="sk"

if [ -z "${1-}" ]; then
  read -rp 'Search Torrent: ' query
else
  query="$*"
fi

query="${query// /+}"

curl -s "$base_url/search/$query/1/" > "$tmp_html"

# Get Titles
grep -o '<a href="/torrent/.*</a>' "$tmp_html" |
  sed 's/<[^>]*>//g' > "$titles"

result_count=$(wc -l "$titles" | awk '{print $1}')
if [ "$result_count" -lt 1 ]; then
  echo "😔 No Result found. Try again 🔴"
  exit 0
fi

# Seeders and Leechers
grep -o '<td class="coll-2 seeds.*</td>\|<td class="coll-3 leeches.*</td>' "$tmp_html" |
  sed 's/<[^>]*>//g' | sed 'N;s/\n/ /' > "$seeders_leechers"

# Size
grep -o '<td class="coll-4 size.*</td>' "$tmp_html" |
  sed 's/<span class="seeds">.*<\/span>//g' |
  sed -e 's/<[^>]*>//g' > "$sizes"

# Links
grep -E '/torrent/' "$tmp_html" |
  sed -E 's#.*(/torrent/.*)/">.*/#\1#' |
  sed 's/td>//g' > "$links"

# Clearning up some data to display
sed 's/\./ /g; s/\-/ /g' "$titles" |
  sed 's/[^A-Za-z0-9 ]//g' | tr -s " " > "$tmp" && mv "$tmp" "$titles"

awk '{print NR " - ["$0"]"}' "$sizes" > "$tmp" && mv "$tmp" "$sizes"
awk '{print "[S:"$1 ", L:"$2"]" }' "$seeders_leechers" > "$tmp" && mv "$tmp" "$seeders_leechers"

# Getting the line number
line=$(paste -d\   "$sizes" "$seeders_leechers" "$titles" |
  $menu |
  cut -d- -f1 |
  awk '{$1=$1; print}')

echo "🔍 Searching Magnet seeds 🧲"
if [ -z "$line" ]; then
  echo "😔 No Result selected. Exiting.. 🔴"
  exit 0
fi
url=$(head -n "$line" "$links" | tail -n +"$line")
full_url="${base_url}${url}/"

# Requesting page for magnet link
curl -s "$full_url" > "$tmp_html"
magnet=$(grep -o 'magnet:?xt=urn:btih:[a-zA-Z0-9]*' "$tmp_html" | head -n 1)

open -a WebTorrent "$magnet"

echo "🎥 Enjoy Watching ☺️ "
